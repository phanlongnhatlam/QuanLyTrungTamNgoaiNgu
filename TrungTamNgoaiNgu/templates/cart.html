{%extends 'layout/base.html'%}

{%block title%}Giỏ hàng{%endblock%}

{%block content%}
<h1 class="text-center text-success mt-1">GIỎ HÀNG</h1>

{%if 'cart' in session and session['cart']%}
<div class="row">
    <div class="col-md-12">
        <table class="table table-bordered text-center">
            <thead class="bg-light">
                <tr>
                    <th>ID</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Xóa</th>
                </tr>
            </thead>
            <tbody>
                {% for p in session['cart'].values() %}
                <tr id="product{{p.id}}">
                    <td>{{p.id}}</td>
                    <td>{{p.name}}</td>
                    <td>{{"{:,.0f}".format(p.price)}} VND</td>
                    <td>
                        <input type="number" value="{{p.quantity}}" class="form-control text-center mx-auto"
                               style="width: 80px" onblur="updateCart({{p.id}}, this)">
                    </td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCart({{p.id}})">&times;</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="alert alert-info text-end">
    <h3>Tổng số lượng: <span class="cart-counter text-danger">{{stats_cart.total_quantity}}</span> </h3>
    <h3>Tổng tiền dự kiến: <span class="cart-amount text-danger">{{"{:,.0f}".format(stats_cart.total_amount)}} VND </span> </h3>
</div>

<div class="text-end mb-5">
    {% if current_user.is_authenticated %}
        <button class="btn btn-success btn-lg" onclick="checkout()">
            <i class="fas fa-check-circle"></i> Xác nhận Đăng ký
        </button>
    {% else %}
        <div class="alert alert-warning">
            Vui lòng <a href="/login?next=/cart" class="fw-bold">Đăng nhập</a> để đăng ký khóa học.
        </div>
    {% endif %}
</div>

{%else%}
<div class="alert alert-warning text-center mt-4">
    <h4>Hiện không có khóa học nào trong giỏ!</h4>
    <a href="/" class="btn btn-primary mt-3">Quay lại trang chủ</a>
</div>
{%endif%}

<script>
    function updateCart(id, obj) {
        obj.disabled = true;
        fetch(`/api/carts/${id}`, {
            method: "put",
            body: JSON.stringify({
                "quantity": obj.value
            }),
            headers: {
                "Content-Type": "application/json"
            }
        }).then(res => res.json()).then(data => {
            obj.disabled = false;
            let counter = document.getElementsByClassName("cart-counter");
            let amount = document.getElementsByClassName("cart-amount");
            for (let c of counter)
                c.innerText = data.total_quantity;
            for (let a of amount)
                a.innerText = new Intl.NumberFormat().format(data.total_amount) + " VND";
        });
    }

    function deleteCart(id) {
        if (confirm("Bạn chắc chắn muốn xóa khóa học này?") === true) {
            fetch(`/api/carts/${id}`, {
                method: "delete"
            }).then(res => res.json()).then(data => {
                let counter = document.getElementsByClassName("cart-counter");
                let amount = document.getElementsByClassName("cart-amount");
                for (let c of counter)
                    c.innerText = data.total_quantity;
                for (let a of amount)
                    a.innerText = new Intl.NumberFormat().format(data.total_amount) + " VND";

                let e = document.getElementById(`product${id}`);
                e.style.display = "none";
                location.reload(); // Load lại để cập nhật giao diện nếu giỏ hàng rỗng
            });
        }
    }

    // --- HÀM QUAN TRỌNG: CHECKOUT ---
    function checkout() {
        if (!confirm("Bạn chắc chắn muốn đăng ký các khóa học này?\n(Vui lòng đến quầy thu ngân để hoàn tất đóng tiền)"))
            return;

        fetch('/api/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 200) {
                alert(data.msg);
                location.href = "/"; // Đăng ký xong thì về trang chủ
            } else {
                alert("Lỗi: " + data.msg);
            }
        })
        .catch(err => console.error(err));
    }
</script>

{% endblock %}